# PRD：Folder-First Hierarchy（根层仅文件夹）

**成文日期**：2026-02-18 15:28:04 UTC+8
**最后修订**：2026-02-18 16:02:27 UTC+8

本文档用于记录本次需求或开发交付。阅读时当前系统实现可能已发生变化，请以实际代码与产品行为为准，谨慎参考。

> 补充说明：针对“线上与测试共用数据库”场景的无损改造、数据迁移与回滚细化，已拆分到专题包：`docs/prd/20260218_02_folder-first-shared-db-rollout/`。

---

## 文档档位与产物策略

- tier：small
- 交付模式：single_file
- 判档依据：单产品线改造，主要影响 Web + API 行为约束；不涉及跨系统联动和高风险不可逆迁移。
- 升级条件：若后续新增跨服务权限策略、跨租户迁移或外部集成协议变更，升级到 medium。

## 存储路径与命名规范

- root_path：docs/prd
- package_name：20260218_01_folder-first-hierarchy.md
- 命名规则：YYYYMMDD_index_short-slug（short-slug 建议 2-5 词，长度 <= 32）

## 背景与目标

### 背景问题

当前空间内容允许“文件与文件夹并列出现在根层（Root）”，导致：

- 根层信息密度过高，团队难以形成统一目录结构。
- 新用户进入空间后难以快速理解内容边界。
- 文件治理（权限审计、生命周期管理）缺少稳定容器。
- 现有文件移动以单条操作为主，批量治理效率不足。
- 同目录缺少统一置顶能力，重点文件与重点目录不易凸显。

### 目标指标

- 结构目标：Root 层 100% 仅包含文件夹，根层文件新增为 0。
- 体验目标：用户进入空间后优先看到目录结构，降低定位成本。
- 可控目标：历史根层文件可平滑迁移，迁移成功率 >= 99.9%。
- 效率目标：支持多选批量移动，批量移动成功率 >= 99.5%。
- 导航目标：同目录内文件夹与文件均可置顶，置顶生效延迟 P95 <= 1s。

### 用户与角色

- Workspace Owner / Admin：配置开关、执行迁移、查看审计与告警。
- Member / Editor：创建文件夹，在文件夹内创建和移动文件。
- Viewer：只读查看目录树和文件内容。

### 典型用户故事

1. 作为 Member，我希望进入空间时先看到文件夹目录，再进入目录查看文件。  
2. 作为 Admin，我希望禁止在根层创建文件，确保团队遵循统一结构。  
3. 作为 Member，我希望勾选多个文件后可一次移动到目标文件夹，减少重复操作。  
4. 作为 Member，我希望筛选结果后可一键全选并批量移动。  
5. 作为 Admin，我希望批量移动时可直接指定根目录下的目标文件夹。  
6. 作为 Member，我希望同目录下文件夹和文件都支持置顶，便于突出重点内容。  
7. 作为运维，我希望历史根层文件自动迁移且失败可重试、可回滚。  
8. 作为 Viewer，我希望搜索结果展示完整路径，快速判断文件归属。  

## 现状审计（As-Is）

- 现有页面/交互盘点：
  - 根层列表可同时展示文件夹与文件。
  - 新建文件入口可在根层直接触发。
  - 文件移动以逐条操作为主，缺少多选后批量移动入口。
  - 筛选后无法一键全选“当前筛选结果”。
  - 同目录下文件夹与文件缺少统一置顶能力。
- 现有接口盘点：
  - 文件创建接口允许缺省或根层父节点。
  - 目录树接口根层混合返回文件和文件夹。
  - 缺少“按筛选条件批量选中并移动”的接口能力。
  - 缺少文件/文件夹置顶字段与置顶接口。
- 现有数据表盘点：
  - 文件实体存在可空父级关系，导致“无目录归属文件”可落库。
  - 文件和文件夹缺少 `is_pinned / pinned_at` 类排序字段。
- 现有权限与埋点盘点：
  - 权限主要在 Space 级别；目录操作审计维度不足。
  - 缺少“根层文件创建被拦截”专门指标。
  - 缺少“批量移动成功率/冲突率”和“置顶使用率”指标。

## 改造策略确认闸门

- gate_id：G-CHANGE-01
- current_stage：production
- strategy：migrate（兼容过渡）
- user_confirmation：confirmed
- 决策理由与回退约束：
  - 现网已存在历史根层文件，直接 replace 风险高；采用“先迁移再强约束”。
  - 迁移保持文件 ID 不变，优先保证分享链接和引用关系稳定。
  - 回滚仅支持“迁移后未发生二次移动”的文件（可逆窗口 7 天）。

## 能力复用与重复建设审查

- existing_scan：现有文件树、文件创建、拖拽移动能力可复用。
- build_vs_reuse：extend
- non_reuse_reason（若 new_build 必填）：N/A
- consolidation_plan：
  - 在现有内容树能力上扩展“根层类型约束 + 批量移动 + 置顶排序 + 迁移任务 + 错误码”。
  - 不新增平行目录系统，避免重复建设。

## 功能方案（To-Be）

### 1) 信息架构规则

- Root 层仅允许 `folder`。
- `file.parentFolderId` 必填且必须指向有效文件夹。
- 前端与后端双重限制：任意入口都不能创建根层文件。

### 2) 文件夹能力

- 支持根层创建文件夹。
- 支持子文件夹（最大层级 10）。
- 支持文件夹重命名、移动、删除（非空删除需二次确认）。

### 3) 文件操作约束

- 新建文件/上传文件必须选择目标文件夹。
- 将文件拖拽到根层时，前端阻止并提示“请选择目标文件夹”。
- API 侧硬校验，避免旧客户端绕过。

### 4) 文件移动增强（新增）

- 列表支持复选框，多选后显示批量工具栏。
- 支持“筛选后一键全选”：
  - 一键全选作用范围为“当前筛选条件命中的全部文件（跨分页）”。
  - 支持反选/取消个别项，前端展示“已选数量”。
- 支持批量移动到目标文件夹：
  - 目标选择器支持树形浏览 + 关键词搜索。
  - 目标允许指定为“根目录下任一文件夹”。
  - 默认不允许移动到当前目录、子目录或自身目录形成环路。
- 冲突处理：
  - 若目标目录存在同名文件，返回冲突清单并允许“跳过冲突项后继续”。
  - 非冲突项可先成功，整体结果返回 success/failed 明细。

### 5) 根目录文件夹支持指定（新增）

- 在“移动到”弹窗中提供“根目录文件夹”分组。
- 管理员和有写权限成员可直接选定 Root 下一级文件夹作为目标。
- 不支持将文件直接移动到 Root（无文件夹归属）的非法目标。

### 6) 同目录文件夹与文件置顶（新增）

- 在同一父目录下，文件夹和文件均支持“置顶/取消置顶”。
- 支持单条置顶与多选批量置顶（与多选工具栏复用）。
- 排序规则：
  - 第一优先级：`isPinned=true` 的条目置顶展示；
  - 第二优先级：按 `pinnedAt` 倒序；
  - 第三优先级：按现有默认排序（如最近更新）。
- 置顶作用域为“当前父目录内共享”，不跨目录传播。
- 同目录置顶上限建议 50 项，超过时提示先取消部分置顶。

### 7) 历史数据迁移

- 按 Space 维度执行：
  - 自动创建系统文件夹 `历史迁移文件（2026-02-18）`；
  - 批量将根层文件移动到该目录；
  - 迁移过程记录任务日志和失败清单。
- 失败重试：支持断点续跑。
- 回滚：按任务回滚 parent 关系（受回滚窗口与二次操作限制）。

### 8) API 契约调整

- `POST /files`：`parentFolderId` 改为必填。
- `POST /folders`：允许 `parentFolderId=null`（根层文件夹）。
- 对旧客户端错误返回：`422` + `FILE_MUST_BE_IN_FOLDER`。
- 新增批量移动接口：`POST /files/batch-move`。
  - 请求支持 `selectionMode=ids|filtered`。
  - `ids` 模式：显式传 `fileIds`。
  - `filtered` 模式：传筛选条件和 `excludedFileIds`，用于“筛选后一键全选”。
  - 返回 `movedCount / failedCount / conflicts[]`。
- 新增置顶接口：
  - `POST /files/:id/pin`、`POST /files/:id/unpin`。
  - `POST /folders/:id/pin`、`POST /folders/:id/unpin`。
- 列表查询返回 `isPinned`、`pinnedAt` 字段。

### 9) 权限与审计

- 目录能力默认继承 Space 权限，不新增文件夹独立 ACL（本期）。
- 审计记录：创建/重命名/移动/删除文件夹，迁移与回滚操作。
- 批量移动审计记录：操作者、筛选条件摘要、目标文件夹、成功/失败数量。
- 置顶审计记录：对象类型（file/folder）、对象 ID、原状态、新状态。

### 10) 观测与告警

- 指标：
  - 根层文件创建拦截次数。
  - 迁移成功率、迁移耗时 P95。
  - 目录树加载耗时 P95。
  - 批量移动成功率、冲突率、平均批量大小。
  - 置顶操作成功率、同目录置顶数量分布。
- 告警：
  - 迁移失败率 > 1%（小时级）触发告警。
  - `FILE_MUST_BE_IN_FOLDER` 异常突增触发兼容性告警。
  - 批量移动失败率 > 2%（15 分钟窗口）触发告警。

## 改造影响矩阵与灰度切换

| impact_id | 变更类型 | 现状行为（As-Is） | 目标行为（To-Be） | 影响页面/交互 | 影响接口 | 影响数据表 | 影响权限点 | 灰度开关/维度 | 回滚动作 | 回归用例ID |
|---|---|---|---|---|---|---|---|---|---|---|
| IM-001 | 交互规则 | 根层可直接新建文件 | 根层仅可新建文件夹 | 空间首页、快捷新建 | POST /files | file.parent_folder_id | Space 写权限 | `folder_first_mode` 按空间灰度 | 关闭开关恢复旧入口 | TC-FF-001 |
| IM-002 | API 约束 | `parentFolderId` 可空 | `parentFolderId` 必填 | 新建文件弹窗 | POST /files | 文件父级约束 | 写权限校验保持不变 | 按 workspace_id 灰度 | 放开必填校验 | TC-FF-002 |
| IM-003 | 数据迁移 | 历史根层文件散落 | 统一迁移到系统文件夹 | 文件树、搜索路径 | 迁移任务 API | parent 关系批量更新 | 迁移任务执行权限 | 按 space 分批迁移 | 按任务回滚 parent | TC-FF-003 |
| IM-004 | 拖拽行为 | 文件可拖到根层 | 文件拖到根层被阻止 | 文件树拖拽 | PATCH /files/move | 无新增字段 | 拖拽权限不变 | 前端灰度开关 | 关闭拦截恢复旧行为 | TC-FF-004 |
| IM-005 | 搜索呈现 | 结果路径不稳定 | 返回完整目录路径 | 全局搜索 | GET /search | 无 | 读权限不变 | 全量发布 | 回退旧路径渲染逻辑 | TC-FF-005 |
| IM-006 | 批量操作 | 仅逐条移动 | 支持多选批量移动 | 列表页、批量工具栏 | POST /files/batch-move | 无新增字段 | 目标目录写权限校验 | `bulk_move_mode` 按空间灰度 | 关闭批量入口并回退单条移动 | TC-FF-006 |
| IM-007 | 选择模型 | 筛选后不可全选跨分页 | 筛选后一键全选并可排除部分 | 列表筛选区 | POST /files/batch-move | 无新增字段 | 同 IM-006 | `bulk_select_all_mode` 按 workspace_id | 回退仅当前页全选 | TC-FF-007 |
| IM-008 | 根目录目标 | 目标目录选择路径长 | 支持指定根目录下文件夹作为目标 | 移动弹窗 | GET /folders/tree | 无 | 目标目录写权限 | `root_target_picker_mode` | 回退到完整树选择 | TC-FF-008 |
| IM-009 | 排序规则 | 无统一置顶 | 同目录文件夹/文件均支持置顶 | 列表排序、卡片视图 | POST /files/:id/pin; POST /folders/:id/pin | `is_pinned`,`pinned_at` | 置顶操作权限校验 | `pin_mixed_mode` 按空间灰度 | 关闭置顶并回退默认排序 | TC-FF-009 |

### 灰度策略

- 第 1 阶段（10% 空间）：启用 `folder_first_mode` + 单条移动增强。
- 第 2 阶段（30% 空间）：开启 `bulk_move_mode` 与 `bulk_select_all_mode`。
- 第 3 阶段（60% 空间）：开启 `root_target_picker_mode` 与 `pin_mixed_mode`。
- 第 4 阶段（100%）：全量启用并关闭旧行为入口。

### 回滚策略

- 触发条件：
  - 迁移失败率 > 5%；
  - 批量移动失败率 > 2% 持续 15 分钟；
  - 关键操作错误率持续 15 分钟高于阈值。
- 回滚步骤：
  - 关闭 `folder_first_mode`；
  - 按需关闭 `bulk_move_mode`、`bulk_select_all_mode`、`pin_mixed_mode`；
  - 停止迁移任务调度；
  - 对受影响空间执行 parent 关系回滚（仅可逆范围）。
- 回滚目标时长：<= 30 分钟。

## 验收标准

### 功能验收

- 在任意入口无法创建根层文件（前端阻止 + 后端拒绝）。
- 根层列表仅显示文件夹。
- 历史根层文件迁移后可正常打开、编辑、搜索。
- 列表支持多选文件并批量移动到目标文件夹。
- 筛选后支持一键全选全部命中文件并执行移动。
- 移动弹窗支持直接指定根目录下目标文件夹。
- 同目录下文件夹与文件均支持置顶/取消置顶，排序正确。

### 接口验收

- `POST /files` 缺失 `parentFolderId` 返回 `422` + `FILE_MUST_BE_IN_FOLDER`。
- `POST /folders` 支持根层创建成功。
- 迁移任务接口返回执行统计（总数、成功、失败、重试）。
- `POST /files/batch-move` 支持 `ids` 与 `filtered` 两种选择模式。
- 置顶接口返回状态与时间字段，列表接口可读取 `isPinned/pinnedAt`。

### 回归验收

- 权限回归：Owner/Admin/Member/Viewer 行为符合既有 Space 权限。
- 搜索回归：文件命中结果包含正确路径。
- 操作回归：拖拽、重命名、移动、删除在目录模式下行为一致。
- 批量回归：多选、筛选、全选、排除、冲突跳过链路稳定。
- 排序回归：置顶与默认排序叠加时结果稳定，无闪动/错位。

## 修改日志

- 2026-02-18 15:28:04 UTC+8：初始化文档骨架。
- 2026-02-18 15:34:20 UTC+8：补全“根层仅文件夹”产品方案、影响矩阵、灰度与回滚。
- 2026-02-18 15:55:45 UTC+8：细化“多选批量移动 + 筛选后一键全选 + 指定根目录文件夹 + 同目录文件夹/文件置顶”方案。
- 2026-02-18 16:02:27 UTC+8：新增 medium 专题包，补充共享 DB 下的数据改造与无影响发布方案。
