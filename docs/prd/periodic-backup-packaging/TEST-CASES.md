# 验收测试用例矩阵：定期备份打包

## 1. 功能用例

| ID | 场景 | 前置条件 | 操作 | 预期结果 |
|---|---|---|---|---|
| F-01 | 创建备份策略 | Owner/Admin 已登录 | 新建“每日 02:00，保留 30 天”策略 | 策略保存成功并可见 |
| F-02 | 手动触发备份 | 存在有效策略 | 点击“立即备份” | 生成任务，状态从 `pending` 到 `success` |
| F-03 | 定时自动执行 | 策略已启用 | 等待触发时间 | 自动生成任务并成功 |
| F-04 | 备份包结构校验 | 任务成功 | 下载并解包 | 存在 `manifest.json`、DB dump、storage、checksum |
| F-05 | 保留策略清理 | 已有超期备份 | 触发清理流程 | 超期产物被删除，未超期保留 |
| F-06 | 本地存储模式 | `STORAGE_DRIVER=local` | 执行备份 | 本地附件被正确打包 |
| F-07 | S3 存储模式 | `STORAGE_DRIVER=s3` | 执行备份 | S3 附件被正确打包 |
| F-08 | Dry-run 恢复 | 存在成功备份包 | 执行 dry-run | 输出校验报告，不修改业务数据 |
| F-09 | 正式恢复 | 备份包有效 | 执行 apply restore | 数据与附件恢复可用 |
| F-10 | 审计日志 | 执行备份/恢复/下载 | 查询审计日志 | 记录包含操作人、时间、动作和对象 |

## 2. 权限与安全用例

| ID | 场景 | 操作 | 预期结果 |
|---|---|---|---|
| S-01 | 非管理员创建策略 | 普通成员调用创建策略 API | 返回 403 |
| S-02 | 非管理员下载备份包 | 普通成员请求下载 URL | 返回 403 |
| S-03 | 下载链接过期 | 使用过期链接下载 | 返回鉴权失败 |
| S-04 | 产物完整性防篡改 | 人工篡改包文件后恢复 | 校验失败并拒绝恢复 |
| S-05 | 密钥泄露防护 | 检查日志/告警内容 | 不出现密钥明文 |

## 3. 异常与容错用例

| ID | 场景 | 注入故障 | 预期结果 |
|---|---|---|---|
| E-01 | DB 连接失败 | 断开数据库连接 | 任务失败并给出明确错误 |
| E-02 | 目标存储不可写 | 移除写权限 | 任务失败，记录错误码 |
| E-03 | 磁盘空间不足 | 模拟低磁盘 | 任务被阻止或失败并告警 |
| E-04 | 备份中断 | 进程重启/杀进程 | 任务最终状态可追踪，半成品可清理 |
| E-05 | 并发触发冲突 | 同时触发多个备份 | 仅允许一个运行，其余排队或拒绝 |
| E-06 | 恢复过程中失败 | 恢复中断 | 输出阶段报告并停止后续覆盖 |

## 4. 性能与容量用例

| ID | 场景 | 数据规模 | 目标 |
|---|---|---|---|
| P-01 | 中等规模备份 | 100GB（含附件） | 备份完成时间 <= 90 分钟 |
| P-02 | 大量小文件 | 100 万小文件 | 不发生 OOM，吞吐稳定 |
| P-03 | 恢复时延 | 100GB | RTO <= 120 分钟（环境达标前提） |
| P-04 | 连续稳定性 | 7 天连续任务 | 成功率 >= 99% |

## 5. 回归与发布门禁

- 必过用例：`F-02`、`F-03`、`F-04`、`F-08`、`F-09`、`S-01`、`S-04`、`E-05`
- 发布前门禁：
  - 至少 1 次完整恢复演练成功；
  - 告警链路联调通过；
  - 关键指标可在监控面板实时查看。
