# 上线计划与运维手册：定期备份打包

## 1. 分阶段交付计划

## Phase 0：设计与准备（1 周）

- 完成 PRD/技术评审与风险评审。
- 明确默认策略（每日备份、保留 30 天）和权限模型。
- 准备告警与监控面板模板。

## Phase 1：MVP（2 周）

- 交付内容：
  - 手动触发备份（数据库 + 文件）
  - 任务状态查询
  - 本地存储产物（`BACKUP_LOCAL_PATH`）
  - 基础审计日志
- 发布门槛：
  - 连续 20 次任务成功率 >= 95%
  - 至少 1 次端到端恢复演练成功

## Phase 2：定时策略与保留清理（2 周）

- 交付内容：
  - Cron 策略管理
  - 自动清理过期备份
  - 告警规则（失败/超时/最近无成功）
  - S3 目标存储支持
- 发布门槛：
  - 连续 7 天稳定运行
  - 恢复 dry-run 通过率 100%

## Phase 3：增强能力（后续）

- 可选加密增强（KMS 集成）
- 恢复引导向导与报告可视化
- 分片备份与大体量性能优化

## 2. 运行标准（SRE）

- 任务并发：`1`（默认）
- 失败重试：最多 `3` 次，指数退避
- 超时阈值：单任务 `180` 分钟（可配置）
- 备份窗口：优先设置在业务低峰期
- 磁盘水位保护：
  - 可用空间 < 20% 时触发预警
  - 可用空间 < 10% 时阻止新任务启动

## 3. 告警策略

- P1：
  - 最近 24 小时无成功备份
  - 恢复任务失败
- P2：
  - 连续 2 次备份失败
  - 任务耗时超过基线 P95 的 2 倍
- P3：
  - 备份包校验失败（但有可用历史备份）

## 4. 运维 Runbook

## 4.1 备份失败排障顺序

1. 查看任务日志（`jobId`、错误码、堆栈）。
2. 检查数据库连通性与权限。
3. 检查目标存储权限（本地路径可写 / S3 IAM）。
4. 检查节点磁盘与 I/O。
5. 执行手动重试并观察指标。

## 4.2 恢复演练流程（建议每月）

1. 在隔离环境拉起同版本 Docmost。
2. 导入最近一次成功备份包。
3. 执行自动一致性检查：
   - 样本页面可读；
   - 附件可下载；
   - 关键计数（workspace/page/attachment）比对。
4. 输出演练报告并归档。

## 5. 安全运行要求

- 备份下载链接默认短时效（例如 10 分钟）。
- 备份存储桶开启版本控制与对象锁（如平台支持）。
- 限制可访问备份产物的角色范围。
- 禁止在日志、告警消息中输出密钥明文。

## 6. 变更管理

- 生产启用前必须完成：
  - 安全评审；
  - 恢复演练；
  - 监控告警联调。
- 任意备份策略变更（频率/保留/目标）需记录审计事件。

## 7. 发布后 30 天检查项

- 备份成功率是否达到目标（>=99%，按周）。
- 是否存在“无备份但未告警”的漏报。
- 恢复演练是否按计划执行。
- 用户反馈中是否出现“恢复不完整”类问题。
