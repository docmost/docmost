# PRD：Docmost 定期备份打包文件能力

## 0. 文档信息

- 功能名称：定期备份打包文件（Scheduled Backup Packaging）
- 文档版本：v1.0
- 文档日期：2026-02-17
- 状态：Draft for Review
- 适用版本：Docmost self-hosted（开源版优先，企业版兼容）

## 1. 背景与问题

当前 Docmost 具备页面/空间导出能力，但缺少“实例级、可定时、可审计、可验证恢复”的备份机制。自托管用户通常需要：

- 定期生成可离线保存的备份包；
- 覆盖数据库与附件文件，避免“只备份库不备份文件”导致恢复不完整；
- 明确保留周期、失败告警和恢复演练闭环。

缺失该能力会导致数据丢失风险升高，并增加运维门槛。

## 2. 产品目标与非目标

## 2.1 目标

- 提供“按策略自动执行”的实例级备份打包能力。
- 备份包可用于完整恢复（数据库 + 文件存储 + 元数据）。
- 提供可观测执行状态（成功/失败、耗时、大小、错误原因）。
- 满足基础灾备指标：
  - 默认 RPO <= 24h；
  - 默认 RTO <= 120min（中等规模实例，见非功能约束）。

## 2.2 非目标（v1 不做）

- 不做跨版本自动迁移修复（仅保证同大版本恢复）。
- 不做跨云厂商一键迁移编排（允许人工恢复流程）。
- 不做实时持续复制（CDC 级别能力留待后续版本）。

## 3. 用户与角色

- Workspace Owner / Admin：配置备份策略、手动触发、下载与恢复。
- 运维/SRE：监控任务、处理告警、执行恢复演练。
- 安全/合规负责人：审计备份访问记录、校验加密策略。

## 4. 典型用户故事

1. 作为 Owner，我希望每天凌晨自动生成备份包并保留最近 30 天，以满足灾备要求。
2. 作为运维，我希望备份失败后在 5 分钟内收到告警并可快速重试。
3. 作为安全负责人，我希望备份包全程加密并具备校验和，防止泄露与篡改。
4. 作为管理员，我希望先做“干跑恢复校验（dry-run）”，确认可恢复再进行正式恢复。

## 5. 功能范围（In Scope）

## 5.1 备份策略管理

- 支持启停备份策略。
- 支持 Cron 表达式或预设频率（每小时/每天/每周）。
- 支持保留策略（按天数或按份数）。
- 支持目标存储位置：
  - 本地目录（默认）；
  - S3 兼容对象存储（可选）。

## 5.2 备份内容与打包格式

每份备份包必须至少包含：

- 数据库快照（PostgreSQL dump，压缩存储）。
- 文件存储快照：
  - `STORAGE_DRIVER=local`：打包 `/app/data/storage` 对应内容；
  - `STORAGE_DRIVER=s3`：打包配置 bucket/prefix 下 Docmost 对象。
- 备份元数据（`manifest.json`）：
  - Docmost 版本、创建时间、实例标识、存储驱动、备份策略 ID、文件清单与 checksum。

建议打包格式：`tar.zst`（或 `tar.gz` 作为兼容回退）。

## 5.3 执行与调度

- 支持定时触发与手动触发。
- 同一实例同一时间仅允许 1 个备份任务运行（防重入锁）。
- 支持失败重试（指数退避，默认最多 3 次）。
- 备份任务状态机：`pending` -> `running` -> `success` / `failed` / `canceled`。

## 5.4 恢复能力

- 提供恢复前校验：
  - 包完整性校验（checksum）；
  - 版本兼容性校验；
  - 目标环境资源校验（磁盘空间、数据库连接、存储可写）。
- 支持 dry-run 恢复校验（不落库）和正式恢复。
- 恢复操作默认要求二次确认并记录审计日志。

## 5.5 可观测性与告警

- 任务列表与详情：开始/结束时间、耗时、包大小、错误摘要、触发方式。
- 指标上报：成功率、失败率、P95 耗时、最近一次成功时间。
- 告警策略：
  - 连续失败 >= 2 次触发高优先级告警；
  - 最近 24h 无成功备份触发告警。

## 5.6 权限与审计

- 仅 Workspace Owner/Admin 可配置或触发备份恢复。
- 下载备份包需短时效签名链接或临时授权。
- 审计日志记录：谁在何时执行了什么动作（创建策略、下载、恢复、删除）。

## 6. 非功能需求（NFR）

- 安全性：
  - 传输加密（TLS）；
  - 存储加密（服务端或应用层）；
  - 最小权限访问（最小化 S3 IAM 权限）。
- 可靠性：
  - 备份任务成功率 >= 99%（按周）；
  - 备份包校验通过率 = 100%（上线后门禁指标）。
- 性能：
  - 单任务资源配额可配置，避免对在线流量造成明显抖动；
  - 对中等规模实例（100GB 内）备份窗口建议 <= 90 分钟。
- 可维护性：
  - 关键错误具备可定位日志；
  - 支持按任务 ID 全链路排障。

## 7. 业务指标（Success Metrics）

- M1：开启备份策略的活跃实例占比 >= 60%（上线 2 个版本周期后）。
- M2：最近 7 天至少一次成功备份的实例占比 >= 95%。
- M3：恢复演练成功率 >= 95%。
- M4：与“备份缺失/无法恢复”相关的 P1 工单下降 50%。

## 8. 依赖与风险

- 依赖：
  - PostgreSQL dump 工具可用性；
  - 对象存储权限配置正确；
  - 节点磁盘容量与 I/O 预算。
- 主要风险：
  - 大体量附件导致备份窗口过长；
  - 恢复过程误操作覆盖生产数据；
  - 备份包泄露带来的敏感信息风险。
- 缓解策略：
  - 分片与限流；
  - 强制 dry-run + 二次确认；
  - 默认加密、访问最小权限与审计。

## 9. 验收标准（高层）

- 可以创建并保存备份策略。
- 定时任务按策略触发，连续 7 天稳定运行。
- 备份包可下载并通过完整性校验。
- 基于备份包完成一次端到端恢复演练并通过验收。
- 告警、审计、任务可观测性全部可用。
