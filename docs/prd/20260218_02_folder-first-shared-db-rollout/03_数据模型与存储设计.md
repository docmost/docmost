# 03 数据模型与存储设计

**成文日期**：2026-02-18 16:01:48 UTC+8
**最后修订**：2026-02-18 21:00:00 UTC+8

本文档用于定义核心实体、字段与存储策略。阅读时当前系统实现可能已发生变化，请以实际代码与产品行为为准，谨慎参考。

---

## 核心结论（回答“是否需要改表”）

- 需要数据层变更，但采用**最小侵入方案**：
  - 不对现有核心热表 `pages` 做破坏式改造；
  - 优先新增扩展表与任务表；
  - 通过 feature flag + channel guard 控制行为生效范围。
- 数据红线：
  - 默认不改写历史 `pages.parent_page_id`；
  - 仅在人工触发迁移任务时改写父子关系；
  - 不删除、不覆盖历史正文与页面记录。

## 节点语义与正文存储约束（新增）

- `pages` 继续作为 file/folder 的统一实体承载，节点类型由 `page_node_meta.node_type` 判定。
- `folder` 节点不要求新增独立正文表；正文字段即使存在也不作为 UI 编辑入口。
- 前端渲染约束：
  - `node_type=folder`：右侧进入目录视图；
  - `node_type=file`：右侧进入正文编辑器。
- 数据一致性约束（应用层）：
  - 创建/移动统一遵循层级矩阵：

| 父节点 | 子 folder | 子 file |
|---|---|---|
| root | 允许 | 拒绝 |
| folder | 允许 | 允许 |
| file | 拒绝 | 允许 |

## 现网数据盘点与迁移成本评估

| 表名 | 当前行数级别 | 热点索引 | 读写 QPS | 本次变更类型 | 回填方式 | 一致性校验 | 回滚脚本 |
|---|---|---|---|---|---|---|---|
| pages | 高 | slug/搜索相关 | 高 | 不改结构，仅读写关联扩展表 | 不回填历史 parent；仅手动迁移任务改写 | 抽样校验 1% + 全量计数对账 | rollback_folder_migration.sql |
| spaces | 中 | slug/workspace | 中 | 不改结构 | 无 | 无 | N/A |
| workspaces | 低 | 主键 | 低 | 不改结构 | 无 | 无 | N/A |
| page_node_meta（新增） | 新 | page_id, parent+pin | 中 | 新增表 | 迁移脚本初始化 + 写路径兜底补齐 | 行数与 pages 对账 | drop/clear by workspace |
| workspace_release_channel（新增） | 新 | workspace_id unique | 低 | 新增表 | 初始化全量 `prod` | workspace 数对账 | revert channel values |
| folder_migration_jobs/items（新增） | 新 | workspace+status | 低 | 新增表 | 任务驱动 | 任务明细校验 | 按任务反向执行 |

## 新增表设计（新增表优先）

### 表 1：`page_node_meta`

- 粒度（主键）：`page_id`
- 业务含义：承载页面节点扩展语义（file/folder、pin）
- 字段：
  - `page_id uuid pk fk -> pages.id`
  - `workspace_id uuid not null`
  - `space_id uuid not null`
  - `node_type varchar(16) not null default 'file'`（枚举：`file|folder`）
  - `is_pinned boolean not null default false`
  - `pinned_at timestamptz null`
  - `created_at timestamptz not null default now()`
  - `updated_at timestamptz not null default now()`
- 索引：
  - `idx_page_node_meta_space_pin(space_id, is_pinned, pinned_at desc)`
  - `idx_page_node_meta_workspace_type(workspace_id, node_type)`
- 约束：
  - `check (node_type in ('file','folder'))`

### 表 2：`workspace_release_channel`

- 粒度（主键）：`workspace_id`
- 字段：
  - `workspace_id uuid pk fk -> workspaces.id`
  - `release_channel varchar(16) not null default 'prod'`（`prod|staging`）
  - `updated_by uuid null fk -> users.id`
  - `updated_at timestamptz not null default now()`
- 用途：共享 DB 下的写隔离。

### 表 3：`folder_migration_jobs`

- 粒度：`job_id`
- 字段：
  - `id uuid pk`
  - `workspace_id uuid not null`
  - `space_id uuid not null`
  - `status varchar(16) not null`（`pending|running|success|failed|rolled_back|canceled`）
  - `total_count int not null default 0`
  - `success_count int not null default 0`
  - `failed_count int not null default 0`
  - `created_by uuid`
  - `created_at/updated_at`

### 表 4：`folder_migration_job_items`

- 粒度：`job_id + page_id`
- 字段：
  - `job_id uuid fk`
  - `page_id uuid fk`
  - `old_parent_page_id uuid null`
  - `new_parent_page_id uuid null`
  - `status varchar(16)`
  - `error_code varchar(64) null`
  - `updated_at timestamptz`
- 作用：精确回滚与失败重试。

## 数据迁移步骤与回滚策略

### 迁移目标

- 在不影响线上默认行为的前提下，为指定 workspace 提供 folder-first 能力。

### 迁移步骤

1. Step 1：上线 DDL（仅新增表，不改旧表字段）。
2. Step 2：初始化 `workspace_release_channel`（全量默认 `prod`）。
3. Step 3：初始化 `page_node_meta`（仅新增扩展语义，不改写 `pages.parent_page_id`）。
4. Step 4：开启 workspace feature flags，切新读写路径（仍不自动迁移历史根层文件）。
5. Step 5（可选）：Owner/Admin 手动触发根层文件迁移任务（记录 job/items，可回滚）。

### 一致性校验

- 对账 1：`pages` 行数 == `page_node_meta` 行数（目标 workspace 范围）。
- 对账 2：迁移 job `success_count + failed_count == total_count`。
- 对账 3：未执行手动迁移的 workspace，`pages.parent_page_id` 关系保持不变。
- 对账 4：已执行手动迁移的 workspace，根层文件数迁移后为 0。

### 回滚策略

- 回滚顺序：停止写入 -> 关闭开关 -> 按 `job_items` 还原 `parent_page_id` -> 校验。
- 不回滚 DDL（新增表保留），仅回滚行为与数据关系。
- 若未执行手动迁移任务，仅需关闭开关，无需数据回滚。

## DDL 草案（示意）

```sql
create table if not exists page_node_meta (
  page_id uuid primary key references pages(id) on delete cascade,
  workspace_id uuid not null references workspaces(id) on delete cascade,
  space_id uuid not null references spaces(id) on delete cascade,
  node_type varchar(16) not null default 'file',
  is_pinned boolean not null default false,
  pinned_at timestamptz null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  check (node_type in ('file','folder'))
);
```

```sql
create table if not exists workspace_release_channel (
  workspace_id uuid primary key references workspaces(id) on delete cascade,
  release_channel varchar(16) not null default 'prod',
  updated_by uuid null references users(id),
  updated_at timestamptz not null default now(),
  check (release_channel in ('prod','staging'))
);
```

## 为什么这样能不影响线上

- 不改 `pages` 结构，不引入大表 rewrite 风险。
- 仅新增表，线上旧逻辑可继续运行。
- 能力按 workspace 开关生效，未开启 workspace 无行为变化。
- 共享 DB 写隔离由 `release_channel` + 中间件强校验兜底。
- 默认不改写历史父子关系，只有手动任务才会改变目录归属。
