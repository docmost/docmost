# 01 产品方案 PRD：Folder-First Shared DB Rollout

**成文日期**：2026-02-18 16:01:48 UTC+8
**最后修订**：2026-02-18 22:30:00 UTC+8

本文档用于定义产品目标、范围与验收标准。阅读时当前系统实现可能已发生变化，请以实际代码与产品行为为准，谨慎参考。

---

## 文档档位与产物策略

- tier：medium
- 交付模式：package_dir
- 判档依据：共享数据库下的生产变更，涉及前端交互、后端接口、数据模型与迁移回滚。

## 存储路径与命名规范

- root_path：docs/prd
- package_name：20260218_02_folder-first-shared-db-rollout
- 命名规则：YYYYMMDD_index_short-slug（short-slug 建议 2-5 词，长度 <= 32）

## 背景与目标

### 背景问题

- 线上与测试共用一套 DB，测试环境误操作会直接污染线上工作区数据。
- 文件夹能力引入后，需表达 `file/folder` 节点类型、置顶状态与批量移动审计。
- 若直接改造核心热表并全量开关，风险不可控。
- 当前交互存在“新建文件夹后进入可编辑正文”的语义混淆，用户难以区分“文件夹”与“文件”。

### 目标指标

- G1：共享 DB 下，测试环境对线上 workspace 的越权写入为 0。
- G2：文件夹能力改造期间，线上核心接口可用性 >= 99.9%。
- G3：按 workspace 灰度，发布过程支持 30 分钟内回滚。
- G4：根层文件新增为 0，批量移动成功率 >= 99.5%。
- G5：完成“轻量化极简风格”统一改造，核心页面（左树/右侧目录/顶部操作区）视觉规范一致性达 100%。

## 数据保护红线（必须满足）

- RDL-1：不删除、不清空、不覆盖现有 `pages` 历史数据。
- RDL-2：默认不自动执行历史根层文件迁移任务（仅允许人工手动触发）。
- RDL-3：未触发手动迁移前，现有节点 `parent_page_id` 关系保持不变。
- RDL-4：所有新能力先灰度到指定 workspace，默认关闭。
- RDL-5：任何数据修复/迁移动作必须具备任务审计与可回滚记录。

### 用户与角色

- Owner/Admin：开启能力、选择灰度 workspace、执行迁移、触发回滚。
- Member/Editor：多选、筛选后一键全选、批量移动、置顶。
- SRE：监控迁移、错误率、共享 DB 隔离告警。

## 现状审计（As-Is）

- 现有页面/交互盘点：根层可直接建文件；移动能力以单条为主；无统一置顶。
- 现有接口盘点：创建和移动接口未约束“根层仅文件夹”；缺少批量移动接口。
- 现有数据表盘点：已存在 `pages(parent_page_id, space_id, workspace_id)`，但缺少节点类型与置顶元数据。
- 现有权限与埋点盘点：权限以 Space 为主；缺少“共享 DB 隔离”与“批量移动结果”埋点。

## 改造策略确认闸门

- current_stage：production
- strategy：migrate
- user_confirmation：confirmed
- 决策理由与回退约束：
  - 生产已运行且共享 DB 风险高，不能直接 replace。
  - 采用新增扩展表 + 双读校验 + workspace 灰度开关。
  - 回退依赖 feature flag 与迁移任务回滚，不依赖紧急 DDL。

## 能力复用与重复建设审查

- existing_scan：复用现有页面树与 `parent_page_id` 层级能力。
- build_vs_reuse：extend
- non_reuse_reason（若 new_build 必填）：N/A
- consolidation_plan：
  - 不新建平行内容系统。
  - 在现有能力上扩展节点语义、批量移动和置顶。

## 改造影响矩阵与灰度切换

| impact_id | 变更类型 | 现状行为（As-Is） | 目标行为（To-Be） | 影响页面/交互 | 影响接口 | 影响数据表 | 影响权限点 | 灰度开关/维度 | 回滚动作 | 回归用例ID |
|---|---|---|---|---|---|---|---|---|---|---|
| IM-001 | 层级规则 | 根层可建文件，父子关系约束弱 | 根层仅 folder；folder 可建 file/folder；file 仅可建 file | 首页、新建弹窗、树拖拽 | POST /pages/create + POST /pages/move | pages + meta | Space 写权限 | folder_first_mode@workspace | 关闭开关 | ACC-001/010/011 |
| IM-002 | 批量移动 | 仅单条移动 | 多选 + 筛选后一键全选批量移动 | 列表与筛选区 | POST /pages/batch-move | 无主表变更 | 目标目录写权限 | bulk_move_mode@workspace | 关闭批量入口 | ACC-002 |
| IM-003 | 根目录目标 | 目标目录选择链路长 | 支持指定 root 下文件夹 | 移动弹窗 | GET /folders/tree | 无主表变更 | 同 IM-002 | root_target_picker_mode | 回退旧选择器 | ACC-003 |
| IM-004 | 置顶规则 | 无统一置顶 | 同目录文件夹/文件均可置顶 | 列表排序 | POST /nodes/pin | page_node_meta | 置顶操作权限 | pin_mixed_mode | 关闭置顶逻辑 | ACC-004 |
| IM-005 | 共享DB隔离 | 测试与线上写入边界弱 | 按 workspace release channel 强校验 | 所有写接口 | 写接口统一中间件 | workspace_release_channel | workspace 访问控制 | channel_guard_mode | 关闭新能力写入 | ACC-005 |
| IM-006 | 迁移任务 | 根层历史文件散落 | 人工确认后按 workspace 手动迁移到系统文件夹 | 目录树、搜索 | migration APIs | migration tables | 迁移执行权限 | migration_mode@workspace | 按任务回滚 parent | ACC-006 |
| IM-007 | 右侧内容区分流 | 点击文件夹进入“类文档编辑态” | 点击文件夹进入目录视图；点击文件进入正文编辑 | 左树节点点击、右侧内容区 | POST /pages/info + POST /pages/sidebar-pages | 无新增表 | Space 读写权限 | folder_view_mode@workspace | 回退到单一编辑视图 | ACC-007 |
| IM-008 | UI 风格升级 | 线框重、图标混用、按钮样式老旧 | 轻量极简风，统一图标/按钮/边框体系 | 左树、右侧目录、顶部栏、弹窗 | 无新增接口 | 无新增表 | 无 | ui_refresh_mode@workspace | 回退旧样式变量 | ACC-012/013/014 |

## 右侧内容区交互模型（Folder/File 分流）

- Folder 节点：
  - 右侧展示“目录视图”，而非正文编辑器。
  - 顶部操作区必须包含“新建文件”主按钮（可同时提供“新建文件夹”次按钮）。
  - 列表区展示该文件夹下的文件夹与文件，排序与左侧树一致（置顶、position 规则一致）。
- File 节点：
  - 右侧展示正文编辑器，保持现有文档编辑能力不变。
- 根目录/任意目录的一致性：
  - 左侧与右侧目录视图对同一父目录的可见子项必须一致（允许虚拟滚动与分页，但最终集合一致）。
- 新建文件夹后行为：
  - 默认停留在目录语义，不进入正文编辑状态；
  - 若当前选中的是新建文件夹，应渲染该文件夹目录视图。

## 轻量化极简风格升级方案（UI Refresh）

### 视觉方向（To-Be）

- 风格关键词：轻量、留白、弱边框、强信息层级。
- 目标：降低视觉噪音，强化“目录结构 + 操作状态”可读性。
- 原则：
  - 内容优先：减少装饰性描边和高对比块面。
  - 状态明确：hover/active/selected 只用一套状态语义。
  - 组件统一：文件/文件夹、按钮、图标、线框使用同一设计语言。

### 改造范围（本期）

- 左侧空间树：节点行高、图标、选中态、hover 态、置顶标识。
- 右侧目录视图：标题区、操作按钮区、子项列表卡片。
- 全局操作按钮：主按钮、次按钮、幽灵按钮（ghost）三类。
- 线框与分割线：边框颜色、粗细、圆角、阴影统一。
- 弹窗（新建/移动）：输入框、确认按钮、列表项样式统一。

### 视觉令牌（Design Tokens，产品口径）

- 颜色：
  - `bg.canvas=#F7F8FA`，`bg.surface=#FFFFFF`，`bg.subtle=#F2F4F7`
  - `text.primary=#111827`，`text.secondary=#5B6473`，`text.tertiary=#8B95A7`
  - `border.default=#E6E8EC`，`border.hover=#D5DAE1`，`border.active=#99A2B3`
  - `accent.primary=#2563EB`，`accent.hover=#1D4ED8`
- 圆角与线框：
  - 控件圆角 `8/10`，卡片圆角 `12`
  - 默认边框 `1px`，禁用厚重多重描边
  - 阴影仅允许 `shadow-sm`（弱阴影）
- 字体与层级：
  - 标题/正文/说明三档，避免同层级混用过多字重
  - 目录树和右侧列表使用一致字号与行高

### 图标样式规范

- 统一线性图标风格（outline），线宽 1.75，圆角端点。
- 文件夹与文件必须显著区分，不允许同图标复用。
- 禁止同一视图混用 filled + outline 图标体系。
- 尺寸统一：树节点 16，操作区 18/20。

### 按钮样式规范

- Primary：实底强调色，用于“新建文件”等主动作。
- Secondary：浅底/描边，用于“新建文件夹”等次动作。
- Ghost：无底弱强调，用于“更多”“取消”等低优先级动作。
- 三态必须一致：`default/hover/disabled`，禁用态可视且不可点击。

### 交互一致性要求

- 左树与右侧目录对同一节点的图标、名称、状态颜色完全一致。
- 文件夹标题与文件标题复用同一标题组件，仅图标/动作区差异化。
- 刷新前后节点类型视觉一致（避免“新建时是文件夹，刷新后像文件”）。

### 灰度与回滚

- 开关：`ui_refresh_mode@workspace`。
- 阶段：
  - P1：staging workspace 开启，验证视觉一致性与可用性。
  - P2：线上小流量 workspace 开启。
  - P3：全量发布。
- 回滚：关闭 `ui_refresh_mode`，恢复旧变量与旧样式映射。

## 层级能力矩阵（统一约束）

| 父节点 | 允许创建子 folder | 允许创建子 file |
|---|---|---|
| root | 是 | 否 |
| folder | 是 | 是 |
| file | 否 | 是 |

- 该矩阵同时适用于创建与移动，禁止“仅前端显示限制、后端不校验”的实现方式。

### 灰度策略

- Phase 1：仅测试专用 workspace 开启（channel=staging），仅启用视图分流与创建约束，不启用迁移任务。
- Phase 2：线上低风险 workspace（10%）开启，观察 24h，仍不自动迁移历史数据。
- Phase 3：线上 30% -> 60% -> 100% 分批开启。
- Phase 4（可选）：仅对明确授权的 workspace 手动执行历史迁移任务。
- 每阶段门禁：错误率、迁移成功率、越权写入拦截量。

### 回滚策略

- 触发条件：
  - 关键写接口错误率 > 1%（15 分钟）；
  - 共享 DB 隔离拦截出现误拦截高峰；
  - 迁移失败率 > 5%。
- 回滚步骤：
  - 关闭对应 workspace feature flags；
  - 停止迁移任务；
  - 执行迁移回滚脚本（仅回滚本次 parent 变更）。
- 回滚目标时长：<= 30 分钟。

## 验收标准

### 功能验收

- 根层无法创建文件，仅可创建文件夹。
- 文件节点可创建下级文件，不可创建下级文件夹。
- 文件夹节点可创建下级文件与下级文件夹。
- 支持多选与筛选后一键全选后批量移动。
- 支持将文件批量移动到指定 root 下文件夹。
- 同目录文件夹与文件均可置顶。
- 点击文件夹时，右侧展示目录视图而不是正文编辑器。
- 目录视图包含“新建文件”入口，且可继续浏览该目录下文件夹/文件。
- 点击文件时，右侧进入正文编辑器（与文件夹视图严格分离）。

### 视觉验收（新增）

- ACC-012：左树与右侧目录中的文件/文件夹图标风格一致，且二者可明确区分。
- ACC-013：按钮样式符合三类体系（Primary/Secondary/Ghost），无历史样式混用。
- ACC-014：线框颜色、分割线、圆角符合本 PRD 视觉令牌定义；核心页面无“厚边框/重阴影”。
- ACC-015：刷新前后节点类型视觉一致，`folder/file` 不发生图标错配。

### 接口验收

- `POST /pages/batch-move` 支持 `ids` 与 `filtered` 模式。
- pin/unpin 接口返回状态字段并可在列表读取。
- channel guard 对非目标 workspace 写请求返回明确错误码。

### 回归验收

- 开关关闭后，新能力不影响原有线上行为。
- 测试环境无法修改线上受保护 workspace。
- 迁移任务可重试、可终止、可回滚。
- 在未手动触发迁移前，历史数据量与父子关系不发生变化。

## 修改日志

- 2026-02-18 16:01:48 UTC+8：初始化文档骨架。
- 2026-02-18 16:02:27 UTC+8：补充共享 DB 场景下的产品方案、影响矩阵、灰度与回滚。
- 2026-02-18 19:35:00 UTC+8：补充 folder/file 右侧内容区分流策略，明确“文件夹目录视图 + 新建文件入口”的交互与验收标准。
- 2026-02-18 19:50:00 UTC+8：补充“数据保护红线”，明确默认不自动迁移历史数据、仅手动触发迁移。
- 2026-02-18 20:10:00 UTC+8：同步技术/数据/风控/实施文档，统一“默认不自动迁移、仅手动任务改写 parent”的执行口径。
- 2026-02-18 21:00:00 UTC+8：补充父子层级矩阵（root/folder/file），并将创建与移动统一到同一约束口径。
- 2026-02-18 22:30:00 UTC+8：新增“轻量化极简风格升级方案”，补充图标/按钮/线框视觉规范、灰度策略与视觉验收项。
