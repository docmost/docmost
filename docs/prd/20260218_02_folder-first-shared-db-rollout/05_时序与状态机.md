# 05 时序与状态机

**成文日期**：2026-02-18 16:01:48 UTC+8
**最后修订**：2026-02-18 20:10:00 UTC+8

本文档用于定义时序流程与状态流转规则。阅读时当前系统实现可能已发生变化，请以实际代码与产品行为为准，谨慎参考。

---

## 关键时序

### 时序 1：灰度 workspace 开启 folder-first

1. Owner 设定 workspace release channel。
2. Owner 开启 `folder_first_mode`。
3. 系统切换到新读写路径（仅视图与创建约束，不改写历史 parent 关系）。
4. 根层历史文件保持原状，等待可选手动迁移。

### 时序 1B：手动执行历史迁移（可选）

1. Owner/Admin 在目标 workspace 手动触发迁移任务。
2. 系统创建迁移 job 与 job items。
3. 任务分批改写目标页面的 `parent_page_id` 并记录前后值。
4. 若失败可按 job 执行回滚，恢复原始父子关系。

### 时序 2：筛选后一键全选批量移动

1. 用户输入筛选条件并触发查询。
2. 用户点击“一键全选（跨分页）”。
3. 系统记录 `selectionMode=filtered + excludedIds`。
4. 用户选择目标文件夹并提交 batch-move。
5. 后端分批执行并回传任务结果。

### 时序 3：共享 DB 写保护

1. 请求进入写接口。
2. 中间件读取 `APP_CHANNEL`。
3. 查询目标 workspace 的 release channel。
4. 若不匹配，直接拒绝；匹配则继续执行业务。

### 时序 4：节点点击后的右侧视图分流

1. 用户在左侧点击一个节点。
2. 前端调用页面详情接口获取 `nodeType`。
3. 若 `nodeType=folder`，右侧切到目录视图并请求该目录子项。
4. 若 `nodeType=file`，右侧切到文档编辑器并加载正文。
5. 目录视图中点击“新建文件”，创建成功后切换到该文件编辑器。

## 状态机

### 迁移任务状态机

- `pending -> running -> success`
- `running -> failed`
- `running -> canceled`
- `success -> rolled_back`

### 批量移动任务状态机

- `queued -> processing -> completed`
- `processing -> partial_failed`
- `processing -> failed`

### 右侧内容区状态机（新增）

- `idle -> loading_node`
- `loading_node -> folder_view`（nodeType=folder）
- `loading_node -> file_editor`（nodeType=file）
- `folder_view -> creating_file`（点击新建文件）
- `creating_file -> file_editor`（创建成功）
- `folder_view -> loading_node`（点击子节点）
- `file_editor -> loading_node`（点击其他节点）

## 状态约束

- 同一 workspace 同时只允许 1 个 folder migration 任务运行。
- 回滚仅允许针对 `success` 状态任务执行。
- canceled 状态任务不允许直接恢复，只能新建任务重跑。
