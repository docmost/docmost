# 04 风控与安全策略

**成文日期**：2026-02-18 16:01:48 UTC+8
**最后修订**：2026-02-18 20:10:00 UTC+8

本文档用于定义权限、限流、审计与安全策略。阅读时当前系统实现可能已发生变化，请以实际代码与产品行为为准，谨慎参考。

---

## 风险清单

- R1：共享 DB 下测试写入线上 workspace。
- R2：批量移动误操作导致大范围结构变更。
- R3：迁移任务失败引起目录树不一致。
- R4：置顶与排序逻辑导致列表性能波动。
- R5：folder/file 视图分流不彻底，误进入编辑态导致用户误操作。
- R6：误触发自动迁移导致历史 `parent_page_id` 被批量改写。

## 权限与资源控制

- 角色：Owner/Admin/Member/Viewer 沿用现有 Space 权限。
- 关键操作额外限制：
  - 修改 workspace release channel：仅 Owner。
  - 执行迁移任务：仅 Owner/Admin，且必须显式提交 workspace 与确认参数。
  - 批量移动：需同时具备源文件更新权限与目标文件夹写权限。

## 数据保护控制点

- 默认不自动触发迁移任务；任何自动调度均视为高风险配置，默认禁用。
- 迁移任务接口必须记录 `operator/workspace_id/space_id/job_id` 审计字段。
- 未执行手动迁移前，`pages.parent_page_id` 不应出现批量变化；如出现即触发告警。

## 共享 DB 隔离安全策略

- `channel guard` 后端强校验，前端不可绕过。
- 所有写接口必须带 `workspace_id` 并在中间件核验。
- 若 channel 不匹配，统一返回 `403 WORKSPACE_CHANNEL_MISMATCH`。

## 审计日志策略

- 审计覆盖：
  - release channel 变更；
  - feature flag 开关；
  - 批量移动；
  - 迁移执行与回滚；
  - folder/file 视图分流关键动作（folder 打开、目录视图新建文件）。
- 审计字段：operator, workspace_id, space_id, action, target, result, request_id, ts。

## 限流与防滥用

- 批量移动接口限流：每用户每分钟 10 次。
- 单次移动上限 500 条。
- filtered 模式默认强制 `space_id` 条件，防全库扫描。

## 安全验收门槛

- 任意 staging 请求无法修改 `release_channel=prod` 的 workspace 数据。
- 审计日志覆盖率 100%（关键写操作）。
- 批量移动错误返回不泄露内部 SQL/栈信息。
