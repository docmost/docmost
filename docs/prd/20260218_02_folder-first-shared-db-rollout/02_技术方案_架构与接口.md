# 02 技术方案：架构与接口

**成文日期**：2026-02-18 16:01:48 UTC+8
**最后修订**：2026-02-18 21:00:00 UTC+8

本文档用于定义技术架构、接口契约与兼容策略。阅读时当前系统实现可能已发生变化，请以实际代码与产品行为为准，谨慎参考。

---

## 架构总览

- 领域层：在现有页面树能力上增加 `node_type(file/folder)` 与 `pin` 语义。
- 应用层：新增批量移动编排、筛选全选选择模型、手动迁移任务编排（默认不触发）。
- 接口层：新增 batch-move/pin 接口，保留旧接口兼容。
- 基础设施：新增扩展表、迁移任务表、workspace release channel 表。
- 展示层：右侧内容区按 `nodeType` 分流为 `FolderView` 与 `FileEditorView`。

## 数据零影响执行约束

- 默认不自动触发历史文件迁移，不自动改写历史 `pages.parent_page_id`。
- 根层历史文件在未手动迁移前继续可见、可读、可检索。
- `page_node_meta` 缺失时读取兜底为 `file`，避免老数据不可见。
- 只有 Owner/Admin 触发迁移任务时，才允许按 workspace 改写父子关系；任务必须记录审计和回滚明细。

## 层级约束矩阵（创建/移动统一）

| 父节点 | 子 folder | 子 file |
|---|---|---|
| root | 允许 | 拒绝 |
| folder | 允许 | 允许 |
| file | 拒绝 | 允许 |

- 服务端必须统一校验：`POST /pages/create` 与 `POST /pages/move` 使用同一约束函数，避免分叉规则。
- 前端仅做交互前置校验（禁用拖拽/隐藏入口），不作为唯一约束来源。

## 前端路由与渲染分流设计

- 路由保持现有 page 路由模型（不新增平行路由），避免分享链接和历史收藏失效。
- 页面加载流程：
  1. 客户端通过 `POST /pages/info` 获取节点详情（必须包含 `nodeType`）。
  2. 若 `nodeType=folder`，渲染 `FolderView`（目录视图）。
  3. 若 `nodeType=file`，渲染 `FileEditorView`（正文编辑器）。
- `FolderView` 最低能力：
  - 展示当前 folder 的直接子节点（文件夹+文件）。
  - 提供“新建文件”主入口（可选“新建文件夹”次入口）。
  - 子节点排序规则与左树完全一致：`isPinned desc, pinnedAt desc, position asc`。
- 兼容策略：
  - 若旧数据缺失 `nodeType`，后端返回默认 `file`，前端按 `file` 渲染。
  - 新客户端兼容旧服务：当 `nodeType` 缺失时走 `file` 兜底。

## 共享 DB 隔离设计

- 新增 `channel guard` 中间件：
  - 服务启动配置 `APP_CHANNEL=prod|staging`。
  - 写接口在执行前校验目标 workspace 的 `release_channel` 是否允许当前 channel。
- 默认策略：
  - `prod` 服务仅允许写 `release_channel=prod` 的 workspace。
  - `staging` 服务仅允许写 `release_channel=staging` 的 workspace。
- 拦截响应：`403` + `WORKSPACE_CHANNEL_MISMATCH`。

## 改造类需求必填：现有接口盘点（As-Is）

| 接口ID | 当前用途 | 调用方 | 当前行为 | 本次改造 | 兼容策略 | 风险等级 | 灰度开关 | 回滚方式 |
|---|---|---|---|---|---|---|---|---|
| API-001 | 创建内容 | Web | 支持根层创建 | 在 `folder_first_mode=on` 时按层级矩阵校验 root/folder/file | 开关关闭时保持旧行为 | medium | folder_first_mode | 关闭校验开关 |
| API-002 | 单条移动 | Web | 单条移动 | 保留 | 与批量并存 | low | bulk_move_mode | 回退单条 |
| API-003 | 列表查询 | Web | 默认排序 | 增加置顶排序层 | 新字段向后兼容 | medium | pin_mixed_mode | 回退旧排序 |
| API-004 | 搜索 | Web | 返回列表 | 增加完整路径 | 兼容旧字段 | low | folder_first_mode | 回退路径拼装 |
| API-005 | 页面详情 | Web | 主要服务文档编辑 | 增加 `nodeType` 驱动右侧视图分流 | 缺失时默认 file | medium | folder_view_mode | 回退统一编辑视图 |

## 新增/调整接口契约（API）

### API-A：批量移动（契约）

- api_id：API-A
- 路径：`POST /pages/batch-move`
- 业务目的：多选 + 筛选后一键全选批量移动。
- 权限：对每个 page 校验 `update` 权限；对目标 folder 校验 `create child` 权限。
- 幂等：`Idempotency-Key` 必填，重复请求返回同一任务结果。

请求体：

```json
{
  "spaceId": "uuid",
  "selectionMode": "ids",
  "pageIds": ["uuid1", "uuid2"],
  "targetFolderId": "uuid"
}
```

```json
{
  "spaceId": "uuid",
  "selectionMode": "filtered",
  "filter": "title contains 'PRD' and updated_at > '2026-01-01'",
  "excludedPageIds": ["uuid3"],
  "targetFolderId": "uuid"
}
```

响应：

```json
{
  "taskId": "uuid",
  "movedCount": 120,
  "failedCount": 3,
  "conflicts": [{ "pageId": "uuid", "reason": "name_conflict" }]
}
```

### API-B：置顶（契约）

- `POST /nodes/:id/pin`
- `POST /nodes/:id/unpin`
- 请求参数：`nodeType=file|folder`。
- 响应字段：`isPinned`, `pinnedAt`。

### API-C：列表查询调整（API）

- `POST /pages/sidebar-pages` 增加返回字段：`nodeType`, `isPinned`, `pinnedAt`。
- 排序顺序：`isPinned desc, pinnedAt desc, position asc`。
- 兼容要求：未触发手动迁移前，根层历史文件仍应出现在对应目录查询结果中。

### API-E：页面详情与目录子项（接口约束）

- `POST /pages/info`
  - 返回字段必须包含：`id`, `title`, `nodeType`, `parentPageId`, `spaceId`。
  - 语义：用于前端判定右侧是 `FolderView` 还是 `FileEditorView`。
- `POST /pages/sidebar-pages`
  - 当请求体含 `pageId=<folderId>` 时，仅返回该 folder 的直接子节点。
  - 该接口作为右侧 `FolderView` 子项数据源，与左侧树共用同一排序与权限模型。

### API-D：workspace release channel（接口）

- `POST /workspaces/:id/release-channel`
- 仅 Owner 可操作，取值：`prod|staging`。
- 用于共享 DB 写隔离。

## 错误码与兼容策略

- `FILE_MUST_BE_IN_FOLDER`：根层创建/移动文件被拒绝。
- `WORKSPACE_CHANNEL_MISMATCH`：当前服务 channel 无权写该 workspace。
- `BATCH_MOVE_PARTIAL_FAILED`：批量任务部分失败，附明细。
- `FOLDER_CANNOT_BE_CHILD_OF_FILE`：文件节点下禁止创建/移动文件夹。
- 兼容策略：旧客户端收到错误码后，提示升级或使用单条移动。

## 性能与限流

- `batch-move` 单次 `pageIds` 上限 500。
- `filtered` 模式后端按批次 100 执行，避免长事务。
- 列表接口 `page_size` 上限 200；排序字段白名单固定。

## 观测与审计

- 关键日志：`request_id`, `workspace_id`, `space_id`, `task_id`, `idempotency_key`。
- 指标：批量移动成功率、部分失败率、channel mismatch 拦截次数。
- 审计：批量移动与置顶均记录操作人、对象、结果。
