# 06 实施计划、测试与回滚

**成文日期**：2026-02-18 16:01:48 UTC+8
**最后修订**：2026-02-18 21:00:00 UTC+8

本文档用于定义实施阶段、测试矩阵与回滚方案。阅读时当前系统实现可能已发生变化，请以实际代码与产品行为为准，谨慎参考。

---

## 发布计划与灰度

### 发布阶段

1. 发布 DDL（新增表）与后端代码，默认不开启新能力。
2. 在 staging channel workspace 启用灰度并验证。
3. 线上按 workspace 10% -> 30% -> 60% -> 100% 灰度发布。
4. 全量稳定后，保留开关 2 周作为保险期。
5. 仅对明确授权 workspace 执行手动迁移任务（可选阶段）。

### 灰度门禁指标

- channel mismatch 拦截异常（误拦截）< 0.1%。
- 批量移动失败率 < 2%。
- 未执行手动迁移前，历史 `parent_page_id` 改写量 = 0。
- 执行手动迁移时，迁移成功率 > 99%。

## 测试要点

### 功能测试

- 根层只允许文件夹。
- file 节点允许创建子 file，不允许创建子 folder。
- folder 节点允许创建子 file 与子 folder。
- 多选 + 筛选后一键全选 + 批量移动完整链路。
- 指定 root 下目标文件夹后移动成功。
- 同目录文件夹与文件置顶排序正确。
- 点击 folder 节点时，右侧必须为目录视图，不出现正文编辑器输入态。
- 目录视图提供“新建文件”入口，创建后进入该新文件编辑器。
- 目录视图下展示的子项集合与左侧树同目录集合一致。

### 接口测试

- `POST /pages/batch-move`：ids/filtered 两模式。
- `POST /nodes/:id/pin`：置顶与取消置顶。
- `WORKSPACE_CHANNEL_MISMATCH`：跨 channel 写请求拒绝。
- 幂等：重复提交 batch-move 不重复写入。
- 迁移接口仅手动触发，不存在自动后台任务触发路径。

### 权限与安全测试

- Viewer 无法批量移动与置顶。
- staging 实例不可写 prod workspace。
- 审计日志字段完整。

## 验收用例（Given-When-Then）

| 用例ID | 场景 | 前置条件 | 操作步骤 | 预期结果 | 验收数据/口径 |
|---|---|---|---|---|---|
| ACC-001 | 根层建文件限制 | folder_first_mode=on | 根层点击新建文件或将文件移动到根层 | 返回业务错误码 | error_code=FILE_MUST_BE_IN_FOLDER |
| ACC-002 | 筛选后一键全选批量移动 | 有 300 条命中数据 | 筛选->全选->移动 | 非冲突项成功，冲突项明细返回 | moved/failed/conflicts |
| ACC-003 | root 目标文件夹选择 | root 下有多个文件夹 | 打开移动弹窗并选择 root 一级目录 | 移动成功 | parentPageId 更新正确 |
| ACC-004 | 混合置顶排序 | 同目录有 file+folder | 分别置顶并刷新列表 | 置顶项按 pinnedAt 排在前面 | 列表顺序一致 |
| ACC-005 | 共享DB隔离 | workspace channel=prod | staging 发起写请求 | 被拒绝 | 403 + WORKSPACE_CHANNEL_MISMATCH |
| ACC-006 | 回滚演练 | 有成功迁移任务 | 执行 rollback job | parent 关系恢复 | rollback success rate |
| ACC-007 | 文件夹视图分流 | 目标节点 nodeType=folder | 左树点击该节点 | 右侧显示目录视图，不可编辑正文 | 右侧无编辑器输入区 |
| ACC-008 | 目录视图创建文件 | 位于 folder 目录视图 | 点击“新建文件” | 创建成功并进入新文件编辑器 | 新文件 parentPageId=当前folder |
| ACC-009 | 历史数据零影响 | 未执行任何手动迁移任务 | 灰度开启并运行 24h | 历史页面父子关系不变 | parent_page_id diff=0 |
| ACC-010 | file 下创建 file | 目标父节点 nodeType=file | 在该节点执行新建文件 | 创建成功 | 新文件 parentPageId=目标file |
| ACC-011 | file 下创建 folder 拒绝 | 目标父节点 nodeType=file | 在该节点执行新建文件夹或拖拽 folder 到该节点 | 返回业务错误码 | error_code=FOLDER_CANNOT_BE_CHILD_OF_FILE |

## 回滚方案

- 回滚触发：
  - 错误率超阈值；
  - 数据一致性对账失败；
  - 隔离策略误拦截造成业务阻断。
- 回滚步骤：
  - 关闭 feature flags；
  - 停止迁移与批量任务入口；
  - 执行 job-based 数据回滚脚本；
  - 对账确认后开放旧路径。
- 回滚时长目标：<= 30 分钟。
- 未执行迁移任务时，仅需关闭开关，不做数据回滚。
